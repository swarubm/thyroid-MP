{% extends "base.html" %}

{% block title %}Find Hospitals - Thyroid Health Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>Find Nearby Hospitals
                </h4>
                <p class="text-muted mb-0">Locate healthcare facilities specializing in thyroid care and endocrinology</p>
            </div>
            <div class="card-body">
                <form method="POST" id="locationForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="location" class="form-label">Enter your location</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   placeholder="City, State or Address" required>
                            <div class="form-text">Enter your city, state, or full address to find nearby hospitals</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Search Hospitals
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- GPS Location Button -->
                <div class="text-center mb-4">
                    <p class="text-muted mb-2">Or use your current location</p>
                    <button type="button" class="btn btn-outline-primary" id="getLocationBtn">
                        <i class="fas fa-location-arrow me-2"></i>Use My Location
                    </button>
                </div>
                
                <!-- Results will be displayed here -->
                <div id="results-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Information Sidebar -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Finding the Right Care
                </h5>
            </div>
            <div class="card-body">
                <h6>What to Look For:</h6>
                <ul class="small">
                    <li><strong>Endocrinologists:</strong> Specialists in thyroid disorders</li>
                    <li><strong>Thyroid Centers:</strong> Dedicated thyroid care facilities</li>
                    <li><strong>Teaching Hospitals:</strong> Often have specialized expertise</li>
                    <li><strong>Insurance Coverage:</strong> Check if the facility accepts your insurance</li>
                </ul>
                
                <h6 class="mt-3">Questions to Ask:</h6>
                <ul class="small">
                    <li>Do you have endocrinologists on staff?</li>
                    <li>What thyroid tests do you offer?</li>
                    <li>Do you perform thyroid ultrasounds?</li>
                    <li>What is the wait time for appointments?</li>
                </ul>
            </div>
        </div>
        
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-phone me-2"></i>Emergency Contacts
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="tel:911" class="btn btn-danger btn-sm">
                        <i class="fas fa-phone me-2"></i>Emergency: 911
                    </a>
                    <a href="tel:1-800-426-4444" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-phone me-2"></i>Poison Control
                    </a>
                    <a href="https://www.thyroid.org" target="_blank" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-globe me-2"></i>American Thyroid Association
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hospital Results Template (hidden) -->
<template id="hospital-template">
    <div class="hospital-result card border mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="hospital-name mb-2"></h5>
                    <p class="hospital-address text-muted mb-2"></p>
                    <div class="hospital-distance text-success small"></div>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm get-directions">
                            <i class="fas fa-directions me-1"></i>Directions
                        </button>
                        <button class="btn btn-outline-secondary btn-sm get-phone">
                            <i class="fas fa-phone me-1"></i>Call
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const locationForm = document.getElementById('locationForm');
    const getLocationBtn = document.getElementById('getLocationBtn');
    const resultsContainer = document.getElementById('results-container');
    const hospitalTemplate = document.getElementById('hospital-template');
    
    // Handle form submission
    locationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const location = document.getElementById('location').value;
        if (location.trim()) {
            searchHospitals(location);
        }
    });
    
    // Handle GPS location
    getLocationBtn.addEventListener('click', function() {
        if (navigator.geolocation) {
            getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Getting Location...';
            getLocationBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    searchHospitalsByCoords(lat, lon);
                },
                function(error) {
                    alert('Unable to get your location. Please enter your address manually.');
                    getLocationBtn.innerHTML = '<i class="fas fa-location-arrow me-2"></i>Use My Location';
                    getLocationBtn.disabled = false;
                }
            );
        } else {
            alert('Geolocation is not supported by this browser. Please enter your address manually.');
        }
    });
    
    // Search hospitals by location
    function searchHospitals(location) {
        resultsContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Searching for hospitals...</p></div>';
        
        const formData = new FormData();
        formData.append('location', location);
        
        fetch('/find_hospitals', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            // Extract results from the response
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const results = doc.querySelector('#results-container');
            
            if (results) {
                resultsContainer.innerHTML = results.innerHTML;
            } else {
                resultsContainer.innerHTML = '<div class="alert alert-info">No hospitals found. Try a different location.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsContainer.innerHTML = '<div class="alert alert-danger">Error searching for hospitals. Please try again.</div>';
        });
    }
    
    // Search hospitals by coordinates
    function searchHospitalsByCoords(lat, lon) {
        resultsContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Searching for hospitals...</p></div>';
        
        // Use reverse geocoding to get address
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(response => response.json())
        .then(data => {
            const address = data.display_name;
            document.getElementById('location').value = address;
            searchHospitals(address);
        })
        .catch(error => {
            console.error('Error:', error);
            resultsContainer.innerHTML = '<div class="alert alert-danger">Error getting location. Please enter your address manually.</div>';
        })
        .finally(() => {
            getLocationBtn.innerHTML = '<i class="fas fa-location-arrow me-2"></i>Use My Location';
            getLocationBtn.disabled = false;
        });
    }
    
    // Handle hospital result interactions
    resultsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('get-directions')) {
            const hospitalName = e.target.closest('.hospital-result').querySelector('.hospital-name').textContent;
            const address = e.target.closest('.hospital-result').querySelector('.hospital-address').textContent;
            const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
            window.open(directionsUrl, '_blank');
        }
        
        if (e.target.classList.contains('get-phone')) {
            const hospitalName = e.target.closest('.hospital-result').querySelector('.hospital-name').textContent;
            alert(`Please call ${hospitalName} directly for their phone number.`);
        }
    });
});
</script>
{% endblock %}